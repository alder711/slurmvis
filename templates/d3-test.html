{% extends "layout.html" %}

{% block heading %}
    <meta charset="utf-8">
    <title>D3 Testing</title>
    <script type="text/javascript" src="static/js/d3-6.2.0.js"></script>
    <script type="text/javascript" src="static/js/jquery-3.5.1.js"></script>
{% endblock %}

{% block body %}
        <!-- 
        ---- BODY HTML
        --->
        <h3>Test of D3 Stuff</h1>

        <div id="dataupdate-container">
            <label for="filename">File:</label>
            <input type="text" id="update-data-input" name="update-data" value="201005.1648/5.large-head-long-small-tail-backfill-gap-filled-jobs-running"><br><br>
            <button id="update-datafile-button" value="Update">Update</button>
        </div>
        <div id="datavis-container">
        </div>
        <!-- 
        ---- /BODY HTML
        --->

        <script type="text/javascript">
            /*
             * Variables
             */
            // The raw data to visualize
            var dataset;
            // Drawing dimensions
            var width  = 450;
            var height = 450;
            var margin = 40;
            // Piechart radius
            var inner_radius = 0;
            var outer_radius = Math.min(width, height)/2 - margin;
            // SVG object
            var svg;
            // Piechart data
            var pie_data;
            // Colors to use for the piechart
            var color;
            // Compute the position of each pie group
            var pie = d3.pie()
            	.value(function(d){ return d.value; });
            // Path generator function for use with pie data
            var arc = d3.arc()
                .innerRadius(inner_radius)
                .outerRadius(outer_radius);
            // Placeholder for arc paths to be generated
            var arcs;

            /*
             * Functions
             */
            // Function to get data from server and present it
            var fetchData = function() {
                    $.ajax({
                        url: "/api/v0/fetch",
                        data: {
                            filename: document.getElementById("update-data-input").value
                        },
                        success: function(result) {
                            if( result ) {
                                updateData(result);
                            } else {
                                console.log("Result is null");
                                console.log(result);
                            }
                        },
                        fail: function(result) {
                            console.log(result);
                        }
                    });
            };
            // Function to update dataset (called after request to server)
            var updateData = function(newdata) {
                dataset = newdata;
                console.log(dataset);
                pie_data = [
                    {"label": "running", "value": dataset.qrunning.length},
                    {"label": "pending", "value": dataset.qpending.length},
                    {"label": "blocked", "value": dataset.qblocked.length}
                ];
                // Define colors to use
                color = d3.scaleOrdinal()
                    .domain(pie_data.map(function(d){ return d.value; }))
                    .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56"]);
                // Create groups per pie wedge
                arcs = svg.selectAll("g.arc")
                    .data(pie(pie_data)) // Use generated pie data for wedge groups
                    .enter()
                    .append("g")
                    .attr("class", "arc")
                    .attr("transform", "translate(" + outer_radius + ", " + outer_radius + ")"); // Shift group over and down by outer radius
                // Draw arc paths
                arcs.append("path")
                    .attr("fill", function(d) {
                        return color(d.value);
                    })
                    .attr("d", arc); // Use the arc function to generate the path
                // Generate text labels
                arcs.append("text")
                    .attr("transform", function(data) {
                        return "translate(" + arc.centroid(data) + ")"; // Put text at mathematical center of wedge
                    })
                    .attr("text-anchor", "middle") // Anchor text at the middle of it
                    .text(function(data) {
                        if( data.value > 0 ) {
                            return data.data.label; // We must use .value because we converted to pie data
                        } else {
                            return;
                        }
                    });

            };

            /*
             * Operation
             */
            // On initial page load, populate dataset with server's testout.json
            dataset = JSON.parse({{ d3_dataset|tojson }});
            console.log("Initial dataset: ");
            console.log(dataset);
            // Draw SVG area
            svg = d3.select("#datavis-container")
                .append("svg")
                    .attr("width", width)
                    .attr("height", height)
            // Get data from server and present it
            fetchData();
            /*
             * Event Handlers
             */
            // Update data if update button clicked
            $( "#update-datafile-button" )
                .on( "click", function() {
                    fetchData();
                });
        </script>
{% endblock %}
